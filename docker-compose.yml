version: '3.8'

services:
  front-client:
    image: 'front-client:latest'
    container_name: front-client
    restart: on-failure
    environment:
      - USER_API_URL=http://user-service:3000/api
      - MENU_API_URL=http://menu-service:3000/api
      - ORDER_API_URL=http://order-service:3000/order
      - CART_API_URL=http://cart-service:3000/api
    ports:
      - '4173:4173'
    networks:
      - app-network
    hostname: front-client

  front-operator:
    image: 'front-operator:latest'
    container_name: front-operator
    restart: on-failure
    environment:
      - USER_API_URL=http://user-service:3000/api
      - MENU_API_URL=http://menu-service:3000/api
      - ORDER_API_URL=http://order-service:3000/api
    ports:
      - '4175:4175'
    networks:
      - app-network
    hostname: front-operator

  user-service:
    image: user-image:latest
    container_name: user-service
    ports:
      - '8910:8910'
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://user_db:5432/food_users_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - FEATURES_ENABLESAVEEDITEDUSER=true
      - FEATURES_ENABLECHANGEPASSWORD=true
      - FEATURES_ENABLESTAFFAUTHVIAPHONENUMBER=false
      - FEATURES_ENABLEREFRESHSESSION=true
    depends_on:
      - user_db
    networks:
      - app-network

  menu-service:
    image: menu-image:latest
    container_name: menu-service
    ports:
      - '8080:8080'
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://menu_db:5432/foodservice
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - FEATURE_BUGWRONGPRICESORTING=true
      - FEATURE_BUGCORRUPTPHOTOSPATHS=true
      - FEATURE_BUGDUPLICATERATINGSAVE=false
      - FEATURE_BUGCATEGORYDELETEALLOWED=true
      - FEATURE_BUGFOODDETAILSWRONGUSERRATING=true
    depends_on:
      - menu_db
    networks:
      - app-network

  order-service:
    image: order-image:latest
    container_name: order-service
    ports:
      - '8096:8096'
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://order_db:5432/mydatabase
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - FEATURE_BUGWRONGORDERNUMBERCOUNTER=true
    depends_on:
      - order_db
    networks:
      - app-network
      
  cart-service:
    image: cart-image:latest
    container_name: cart-service
    ports:
      - "5621:5621"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5621
      - ConnectionStrings__DefaultConnection=Host=cart-postgres;Port=5432;Database=hitsApplicationDb;Username=postgres;Password=root
      - Jwt__Secret=hits2025972303hits2025972303hits20259723032025hits
    depends_on:
      cart-postgres:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    
  cart-postgres:
    image: postgres:15
    container_name: cart-postgres
    environment:
      POSTGRES_DB: hitsApplicationDb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
    ports:
      - "5435:5432"
    volumes:
      - cart_data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      
  user_db:
    container_name: user_db
    image: postgres:15
    volumes:
      - user_db-data:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    environment:
      - POSTGRES_DB=food_users_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    networks:
      - app-network

  menu_db:
    container_name: menu_db
    image: postgres:15
    volumes:
      - menu_db-data:/var/lib/postgresql/data
    ports:
      - '5433:5432'
    environment:
      - POSTGRES_DB=foodservice
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    networks:
      - app-network

  order_db:
    container_name: order_db
    image: postgres:15
    volumes:
      - order_db-data:/var/lib/postgresql/data
    ports:
      - '5434:5432'
    environment:
      - POSTGRES_DB=mydatabase
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    networks:
      - app-network

volumes:
  user_db-data:
  menu_db-data:
  order_db-data:
  cart_data:

networks:
  app-network:
    driver: bridge
