version: '3.8'

services:
  front-client:
    image: 'front-client:latest'
    container_name: front-client
    restart: on-failure
    environment:
      - USER_API_URL=http://user-service:3000/api
      - MENU_API_URL=http://menu-service:3000/api
      - ORDER_API_URL=http://order-service:3000/order
      - CART_API_URL=http://cart-service:3000/api
      - VITE_DISH_NOT_FOUND=${DISH_NOT_FOUND:-false}
      - VITE_TOTAL_COST_NOT_UPDATE=${TOTAL_COST_NOT_UPDATE:-false}
      - VITE_RESETTING_SORTS=${RESETTING_SORTS:-false}
      - VITE_DISH_COUNT_NOT_UPDATE=${DISH_COUNT_NOT_UPDATE:-false}
    ports:
      - '4173:4173'
    networks:
      - app-network
    hostname: front-client

  front-operator:
    image: 'front-operator:latest'
    container_name: front-operator
    restart: on-failure
    environment:
      - USER_API_URL=http://user-service:3000/api
      - MENU_API_URL=http://menu-service:3000/api
      - ORDER_API_URL=http://order-service:3000/api
      - VITE_DISH_NOT_FOUND=${DISH_NOT_FOUND:-false}
      - VITE_TOTAL_COST_NOT_UPDATE=${TOTAL_COST_NOT_UPDATE:-false}
      - VITE_PHOTO_NOT_DELETE=${PHOTO_NOT_DELETE:-false}
      - VITE_FOR_NO_REASON=${FOR_NO_REASON:-false}
      - VITE_ERROR_ADD_NEW_DISH_INTO_ORDER=${ERROR_ADD_NEW_DISH_INTO_ORDER:-false}
      - VITE_ALWAYS_SUCCESS_ABOUT_US=${ALWAYS_SUCCESS_ABOUT_US:-false}
    ports:
      - '4175:4175'
    networks:
      - app-network
    hostname: front-operator

  user-service:
    image: user-image:latest
    container_name: user-service
    env_file:
      - .env
    ports:
      - '8910:8910'
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://user_db:5432/food_users_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - FEATURE_ENABLE_SAVE_EDITED_USER=${ENABLE_SAVE_EDITED_USER:-true}
      - FEATURE_ENABLE_CHANGE_PASSWORD=${ENABLE_CHANGE_PASSWORD:-true}
      - FEATURE_ENABLE_STAFF_AUTH_VIA_PHONE_NUMBER=${ENABLE_STAFF_AUTH_VIA_PHONE_NUMBER:-false}
      - FEATURE_ENABLE_REFRESH_SESSION=${ENABLE_REFRESH_SESSION:-true}
      - FEATURE_ENABLE_INTERNAL_SERVER_ERROR=${ENABLE_INTERNAL_SERVER_ERROR:-false}
      - FEATURE_ENABLE_SAVE_NULLABLE_PROPS=${ENABLE_SAVE_NULLABLE_PROPS:-false}
      - FEATURE_ENABLE_RETURN_EMPTY_RESULT=${ENABLE_RETURN_EMPTY_RESULT:-false}
      - FEATURE_ENABLE_MIXED_UP_TOKENS=${ENABLE_MIXED_UP_TOKENS:-false}
      - FEATURE_ENABLE_EXPIRED_ACCESS_TOKEN=${ENABLE_EXPIRED_ACCESS_TOKEN:-false}
      - FEATURE_ENABLE_OPERATORS_WITH_CLIENTS_BUG=${ENABLE_OPERATORS_WITH_CLIENTS_BUG:-false}
      - FEATURE_ENABLE_SAVE_PASSWORD_BUG=${ENABLE_SAVE_PASSWORD_BUG:-false}
      - FEATURE_ENABLE_SET_ADMIN_ROLE_TO_CLIENT_BUG=${ENABLE_SET_ADMIN_ROLE_TO_CLIENT_BUG:-false}
      - FEATURE_ENABLE_SET_CLIENT_ROLE_TO_OPERATOR_BUG=${ENABLE_SET_CLIENT_ROLE_TO_OPERATOR_BUG:-false}
      - FEATURE_ENABLE_OK_STATUS_BUG=${ENABLE_OK_STATUS_BUG:-false}
      - FEATURE_ENABLE_SAVE_REFRESH_BUG=${ENABLE_SAVE_REFRESH_BUG:-false}
    depends_on:
      - user_db
    networks:
      - app-network

  log-service:
    image: log-image:latest
    container_name: log-service
    env_file:
      - .env
    ports:
      - '8100:8100'
    networks:
      - app-network

  menu-service:
    image: menu-image:latest
    container_name: menu-service
    ports:
      - '8080:8080'
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://menu_db:5432/foodservice
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - FEATURE_BUG_WRONG_PRICE_SORTING=${BUG_WRONG_PRICE_SORTING:-false}
      - FEATURE_BUG_CORRUPT_PHOTOS_PATHS=${BUG_CORRUPT_PHOTOS_PATHS:-false}
      - FEATURE_BUG_DUPLICATE_RATING_SAVE=${BUG_DUPLICATE_RATING_SAVE:-false}
      - FEATURE_BUG_CATEGORY_DELETE_ALLOWED=${BUG_CATEGORY_DELETE_ALLOWED:-false}
      - FEATURE_BUG_FOOD_DETAILS_WRONG_USER_RATING=${BUG_FOOD_DETAILS_WRONG_USER_RATING:-false}
      - FEATURE_BUG_AVG_RATING_INCORRECT=${BUG_AVG_RATING_INCORRECT:-false}
      - FEATURE_BUG_PARTIAL_SAVE=${BUG_PARTIAL_SAVE:-false}
      - FEATURE_BUG_WRONG_USER_DATA=${BUG_WRONG_USER_DATA:-false}
      - FEATURE_BUG_DELETED_FOOD_VISIBLE=${BUG_DELETED_FOOD_VISIBLE:-false}
      - FEATURE_BUG_FOOD_UPDATE_NOT_SAVED=${BUG_FOOD_UPDATE_NOT_SAVED:-false}
      - FEATURE_BUG_ALLOW_RATING_WITHOUT_ORDER=${BUG_ALLOW_RATING_WITHOUT_ORDER:-false}
      - FEATURE_BUG_IGNORE_ONE_PRICE_BOUND=${BUG_IGNORE_ONE_PRICE_BOUND:-false}
      - FEATURE_BUG_DROP_FOOD_PHOTOS_ON_READ=${BUG_DROP_FOOD_PHOTOS_ON_READ:-false}
      - FEATURE_BUG_NAME_SEARCH_CASE_SENSITIVE=${BUG_NAME_SEARCH_CASE_SENSITIVE:-false}
      - FEATURE_BUG_DISTORT_FOOD_PRICE_ON_DETAILS=${BUG_DISTORT_FOOD_PRICE_ON_DETAILS:-false}
      - FEATURE_BUG_SEARCH_EXACT_NAME_ONLY=${BUG_SEARCH_EXACT_NAME_ONLY:-false}
    depends_on:
      - menu_db
    networks:
      - app-network

  order-service:
    image: order-image:latest
    container_name: order-service
    ports:
      - '8096:8096'
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://order_db:5432/mydatabase
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - FEATURE_BUG_WRONG_STATISTIC_COUNTER=${BUG_WRONG_STATISTIC_COUNTER:-false}
      - FEATURE_BUG_WRONG_ORDER_NUMBER_COUNTER=${BUG_WRONG_NUMBER_COUNTER:-false}
      - FEATURE_BUG_WRONG_STATUS_CHANGE=${BUG_WRONG_STATUS_CHANGE:-false}
      - FEATURE_BUG_OPERATOR_WITHOUT_FULL_NAME=${BUG_OPERATOR_WITHOUT_FULL_NAME:-false}
      - FEATURE_BUG_STATUS_HISTORY_NOT_CHANGES=${BUG_STATUS_HISTORY_NOT_CHANGES:-false}
      - FEATURE_BUG_INVALID_PRICE_COUNT_AFTER_DISH_ADD_IN_ORDER=${BUG_INVALID_PRICE_COUNT_AFTER_DISH_ADD_IN_ORDER:-false}
      - FEATURE_BUG_INVALID_PRICE_COUNT_AFTER_DISH_DELETE_FROM_ORDER=${BUG_INVALID_PRICE_COUNT_AFTER_DISH_DELETE_FROM_ORDER:-false}
      - FEATURE_BUG_CANT_GET_DISH_INFORMATION=${BUG_CANT_GET_DISH_INFORMATION:-false}
      - FEATURE_BUG_ERROR_STATUS_CHANGE_WHEN_DECLINE_ORDER=${BUG_ERROR_STATUS_CHANGE_WHEN_DECLINE_ORDER:-false}
      - FEATURE_BUG_NOT_INCREASE_DISH_AMOUNT_AFTER_ADD=${BUG_NOT_INCREASE_DISH_AMOUNT_AFTER_ADD:-false}
    depends_on:
      - order_db
    networks:
      - app-network
      
  cart-service:
    image: cart-image:latest
    container_name: cart-service
    ports:
      - "5621:5621"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5621
      - ConnectionStrings__DefaultConnection=Host=cart-postgres;Port=5432;Database=hitsApplicationDb;Username=postgres;Password=root
      - Jwt__Secret=hits2025972303hits2025972303hits20259723032025hits
      - FeatureFlags__EnableCalculationBug=${ENABLE_CALCULATION_BUG:-false}
      - FeatureFlags__EnableOverflowBug=${ENABLE_OVERFLOW_BUG:-false}
      - FeatureFlags__EnableNewCartLogic=${ENABLE_NEW_CART_LOGIC:-false}
      - FeatureFlags__EnableImageUrlBug=${ENABLE_IMAGE_URL_BUG:-false}
      - FeatureFlags__EnableValidationBug=${ENABLE_VALIDATION_BUG:-false}
      - FeatureFlags__CartItemLimit=50
      - FeatureFlags__JavaServiceUrl=http://localhost:8096

    depends_on:
      cart-postgres:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    
  cart-postgres:
    image: postgres:15
    container_name: cart-postgres
    environment:
      POSTGRES_DB: hitsApplicationDb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
    ports:
      - "5435:5432"
    volumes:
      - cart_data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      
  user_db:
    container_name: user_db
    image: postgres:15
    volumes:
      - user_db-data:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    environment:
      - POSTGRES_DB=food_users_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    networks:
      - app-network

  menu_db:
    container_name: menu_db
    image: postgres:15
    volumes:
      - menu_db-data:/var/lib/postgresql/data
    ports:
      - '5433:5432'
    environment:
      - POSTGRES_DB=foodservice
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    networks:
      - app-network

  order_db:
    container_name: order_db
    image: postgres:15
    volumes:
      - order_db-data:/var/lib/postgresql/data
    ports:
      - '5434:5432'
    environment:
      - POSTGRES_DB=mydatabase
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    networks:
      - app-network

volumes:
  user_db-data:
  menu_db-data:
  order_db-data:
  cart_data:

networks:
  app-network:
    driver: bridge
